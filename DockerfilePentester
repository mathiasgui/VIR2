# Utilisation d'une image Debian comme base
FROM debian:11

# Mise à jour de la liste des paquets et installation des utilitaires de base
RUN apt-get update && apt-get install -y \
    apache2 \
    php7.4 \
    php7.4-mysql \
    libapache2-mod-php7.4 \
    mariadb-server \
    mariadb-client \
    openssl \
    supervisor \
    ssh \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Configuration du service SSH
RUN mkdir /var/run/sshd
RUN echo 'root:live' | chpasswd
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config

# SSH login fix. Otherwise user is kicked off after login
RUN sed 's@session\s*required\s*pam_loginuid.so@session optional pam_loginuid.so@g' -i /etc/pam.d/sshd


# Configuration d'Apache pour activer PHP et le mod_rewrite
RUN a2enmod php7.4 \
    && a2enmod rewrite

# Ajout de la configuration pour autoriser PHP avec l'extension .PHP
RUN echo "AddType application/x-httpd-php .PHP" | tee -a /etc/apache2/apache2.conf

# Copie du fichier de configuration du site Photoblog et activation du site
COPY photoblog.conf /etc/apache2/sites-available/
RUN a2ensite photoblog.conf \
    && a2dissite 000-default.conf
# Configuration d'Apache pour autoriser l'indexation des répertoires
RUN echo '<Directory /var/www/html/photoblog/>' >> /etc/apache2/sites-available/photoblog.conf
RUN echo '    Options Indexes FollowSymLinks' >> /etc/apache2/sites-available/photoblog.conf
RUN echo '    AllowOverride All' >> /etc/apache2/sites-available/photoblog.conf
RUN echo '    Require all granted' >> /etc/apache2/sites-available/photoblog.conf
RUN echo '</Directory>' >> /etc/apache2/sites-available/photoblog.conf

# Copie du contenu du site et du fichier php.ini dans le répertoire du serveur web
COPY Photoblog-main /var/www/html/photoblog/
COPY faille/php.ini /etc/php/7.4/apache2/php.ini

# Modification des droits de propriété pour le répertoire web
RUN chown -R www-data:www-data /var/www/html/photoblog \
    && chmod -R 755 /var/www/html/photoblog

# Création du répertoire pour les sessions PHP
RUN mkdir -p /var/lib/php/sessions && chown -R www-data:www-data /var/lib/php

# Configuration de MariaDB et chargement de la base de données
COPY Photoblog-main/photoblog.sql /var/www/html/photoblog/
RUN mysqld_safe --skip-networking & \
    sleep 5 && \
    mysql -u root -e "GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost' WITH GRANT OPTION;" && \
    mysql -u root -e "FLUSH PRIVILEGES;" && \
    mysql -u root < /var/www/html/photoblog/photoblog.sql && \
    mysqladmin -u root shutdown

# Copie du fichier de configuration de Supervisor
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Exposer uniquement le port 80 pour le trafic HTTP et le port 22 pour SSH
EXPOSE 80 22

# Commande pour démarrer Supervisor
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
